"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}();!function(){var t=function(){function t(e,i,n){_classCallCheck(this,t),this.editor=e,this.options=i,this.fields=n,this.background=i.background,this.width=i.width,this.height=i.height,this.data=void 0,this.elements=[]}return _createClass(t,[{key:"render",value:function(){if(this.options.widthField&&(this.widthField=this.createHiddenField(this.options.widthField)),this.options.heightField&&(this.heightField=this.createHiddenField(this.options.heightField)),this.editor.setAttribute("style","width:"+this.width+"px; height: "+this.height+"px;"),this.editor.setAttribute("class","lodpod-editor-container"),this.setBounds(),this.createToolbar(),this.data.items)for(var t=0;t<this.data.items.length;t++){var e=this.data.items[t];this.addText(e)}this.createFields(),this.renderBg()}},{key:"setBounds",value:function(){this.boundLeft=this.editor.getBoundingClientRect().left,this.boundTop=this.editor.getBoundingClientRect().top,this.boundRight=this.editor.getBoundingClientRect().right,this.boundBottom=this.editor.getBoundingClientRect().bottom}},{key:"createFields",value:function(){var t=this,e=this,i=document.createElement("div");i.setAttribute("class","col-sm-2 clearfix");for(var n=0;n<this.fields.length;n++)!function(n){var o=t.fields[n],r=document.createElement("span");r.setAttribute("class","lodpod-field"),r.innerText=o.text,r.onclick=function(){e.addText(o)},i.appendChild(r)}(n);this.editor.parentNode.before(i)}},{key:"addToolbarItem",value:function(t){var e=document.createElement("div");e.setAttribute("class","lodpod-editor-toolbar-item");var i=document.createElement("label");return i.innerText=t,e.appendChild(i),e}},{key:"renderBg",value:function(){var t=this;this.bgimg&&this.bgimg.remove();var e=document.createElement("div");if(this.editor.appendChild(e),e.setAttribute("class","lodpod-bg-img"),this.background){var i=document.createElement("img");this.bgimg=e,e.appendChild(i),i.src=this.background,i.style.display="block",this.editor.appendChild(e);var n=new Image;n.src=this.background,n.onload=function(){var e=n.width,i=n.height;t.width=e,t.height=i,t.widthField.value=e,t.heightField.value=i,t.editor.style.width=e+"px",t.editor.style.height=i+30+"px",t.setBounds()}}}},{key:"uploadBg",value:function(t){var e=this,i=new FormData;t&&(i.append("file",t),i.append("_token",document.getElementsByName("_token")[0].value));var n=null;n=XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),n.open("post","/admin/lodpodeditortemplates/upload",!0),n.onload=function(){var t=n.responseText;e.background=t,e.renderBg()},n.send(i)}},{key:"setBgClickHandler",value:function(t){var e=t.files[0];e&&this.uploadBg(e)}},{key:"createHiddenField",value:function(t){var e=document.createElement("input");return e.setAttribute("type","hidden"),e.setAttribute("id",t),e.setAttribute("name",t),e}},{key:"createToolbar",value:function(){var t=this,e=document.createElement("div");e.setAttribute("class","lodpod-editor-toolbar clearfix");var i=document.createElement("div");i.setAttribute("class","lodpod-editor-toolbar-item set-bg");var n=document.createElement("input");i.appendChild(n),n.setAttribute("id",this.options.backgroundField),n.setAttribute("name",this.options.backgroundField),n.setAttribute("accept","image/jpg,image/jpeg,image/png,image/PNG"),n.setAttribute("type","file"),n.setAttribute("class","set-bg-btn");var o=document.createElement("span");i.appendChild(o),o.innerText="设置背景图",o.setAttribute("class","set-bg-span"),n.onchange=function(e){t.setBgClickHandler(this)},e.appendChild(i);var r=this.addToolbarItem("字体"),l=document.createElement("button");r.appendChild(l),l.setAttribute("class","lodpod-font-size-btn"),l.setAttribute("type","button"),l.innerText="-";var s=document.createElement("input");r.appendChild(s);var a=document.createElement("button");a.setAttribute("class","lodpod-font-size-btn"),r.appendChild(a),a.setAttribute("type","button"),a.innerText="+",s.setAttribute("ReadOnly","True"),s.setAttribute("id","font-size-control"),s.setAttribute("type","text"),s.setAttribute("value","12"),s.style.width="2em",l.onclick=function(){s.value>0&&(s.value--,t.currentElement.style.fontSize=s.value+"px")},a.onclick=function(){s.value++,t.currentElement.style.fontSize=s.value+"px"},e.appendChild(r);var d=this.addToolbarItem("颜色"),u=document.createElement("input");u.setAttribute("id","color-control"),u.setAttribute("type","color"),d.appendChild(u),u.onchange=function(e){t.currentElement.style.color=this.value},e.appendChild(d),this.editor.appendChild(e),this.toolbar=e,this.initToolbar()}},{key:"set",value:function(t){this.data=t,this.background=t.background}},{key:"changeToolbar",value:function(t){for(var e=this.toolbar.getElementsByTagName("input"),i=0;i<e.length;i++){var n=e[i];"True"===t?n.setAttribute("ReadOnly",t):n.removeAttribute("ReadOnly")}}},{key:"format",value:function(t){return parseInt(t.replace("px",""))}},{key:"getHexColor",value:function(t){for(var e=[],i=t.split("("),n=0;n<3;n++){var o=parseInt(i[1].split(",")[n]).toString(16);1===o.length&&(o+="0"),e[n]=o}return e="#"+e[0]+e[1]+e[2]}},{key:"initToolbar",value:function(){void 0===this.currentElement||null===this.currentElement?this.changeToolbar("True"):(this.changeToolbar("False"),document.getElementById("font-size-control").value=this.format(this.currentElement.style.fontSize),this.currentElement.style.color&&(document.getElementById("color-control").value=this.getHexColor(this.currentElement.style.color)))}},{key:"addText",value:function(t){var e=this,i=t.fontSize?t.fontSize:12,n=t.color?t.color:"rgb(0,0,0)",o=t.id,r=t.top?t.top:50,l=t.left?t.left:50,s=t.width?t.width:"auto",a=t.height?t.height:"auto",d=t.text?t.text:"文本",u=document.createElement("div");this.editor.appendChild(u);var c=document.createElement("div");c.setAttribute("class","el-container"),u.appendChild(c),u.setAttribute("id",o),u.setAttribute("class","lodpod-text"),u.setAttribute("style","color:"+n+";font-size:"+i+"px; top:"+(r+30)+"px;left:"+l+"px; width:"+s+"px; height:"+a+"px;");var h=document.createElement("span");c.appendChild(h),this.currentElement=u,h.innerText=d;var p=document.createElement("a");c.appendChild(p),p.setAttribute("href","javascript:void(0)"),p.innerText="x",p.setAttribute("class","lodpod-editor-close-a"),p.onclick=function(){e.removeItem(this.parentNode)},u.onclick=function(t){t.preventDefault(),e.currentElement=u,e.initToolbar()},u.onmousedown=function(t){t.preventDefault(),this.drag=!0,this.diffx=t.clientX-this.offsetLeft,this.diffy=t.clientY-this.offsetTop},u.onmousemove=function(t){t.preventDefault(),this.drag&&e.moveInArea(t.clientX,t.clientY)&&e.currentElement==this&&(e.currentElement.style.left=t.clientX-this.diffx+"px",e.currentElement.style.top=t.clientY-this.diffy+"px")},u.onmouseup=function(t){t.preventDefault(),this.drag=!1},this.currentElement=u,this.elements.push(u)}},{key:"removeItem",value:function(t){t.remove();var e=this;this.elements.forEach(function(i,n){i.id==t.id&&delete e.elements[n]})}},{key:"moveInArea",value:function(t,e){return t>this.boundLeft&&t<this.boundRight&&e<this.boundBottom&&e>this.boundTop+30}},{key:"get",value:function(){var t={background:this.background,width:this.width,height:this.height,items:[]},e=this;return this.elements.forEach(function(i){t.items.push({top:e.format(i.style.top)-30,left:e.format(i.style.left),width:e.format(i.style.width),height:e.format(i.style.height),text:i.getElementsByTagName("span")[0].innerText.replace(/\<br\>/g,""),id:i.id,color:e.getHexColor(i.style.color),fontSize:e.format(i.style.fontSize)})}),t}}]),t}();window.LodpodEditor=t}();